<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="http://d3js.org/topojson.v3.min.js"></script>
    <link rel="stylesheet" href="style.css">

</head>
<body>
    <main>
        <div class="main-content">
            <div id="tabs">
                <button id="region-button" >Region map</button>
                <button id="points-button">Fire Points map</button>
            </div>
            <div id="map-controls">
                <select id="month-select">
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
                <select id="day-select">
                    <option value="-">-</option>
                </select>
                <button id="play-button">Play</button>
                <input type="number" id="anim-interval" placeholder="Animation Interval (s):" value="2">
                <div id="scaling-input">
                    <label for="fire-scale">Fire point scaling:</label>
                    <span id="fire-scale-value">3</span>
                    <input type="range" id="fire-scale" min="1" max="10" value="3">
                </div>
            </div>
            <div class="map-container">
                <svg id="map-svg" width="1000" height="1000"></svg>
            </div>
        </div>
    </main>
    <script>
        const scalingInput = document.getElementById("scaling-input");
        const regionsButton = document.getElementById("region-button");
        const pointsButton = document.getElementById("points-button");
        const fireScaleInput = document.getElementById("fire-scale");
        const fireScaleValue = document.getElementById("fire-scale-value");
        const daySelect = document.getElementById("day-select");
        const animIntervalInput = document.getElementById("anim-interval");
        const width = 1000;
        const height = 1000;
        var animInterval = 2000;
        var selectedMonth;
        var selectedDay;
        var FireScaling = 3;
        var isRegionSet = false;
        var projection = d3.geoMercator();
        var path = d3.geoPath()
            .projection(projection);
        const regionColorScale = d3.scaleLinear()
                                .domain([0, 1200])
                                .range(["#FFBBBB", "#8B0000"]);
        var svg = d3.select("#map-svg")
            .call(d3.zoom()
                .scaleExtent([0, 10])
                .on("zoom", onZoom))
            .append("g");

            function onZoom(event) {
            svg.attr("transform", event.transform);
        }
         

        d3.select("body")
            .append("div")
            .attr("id", "name");
    
        d3.json("ukr.json")
            .then(function (ukr) {
                var ukrFeatures = topojson.feature(ukr, ukr.objects.UKR_adm1);
                projection.fitSize([width, height], ukrFeatures);
                var states = svg.selectAll("path.county")
                    .data(ukrFeatures.features)
                    .enter()
                    .append("path")
                    .attr("class", "county")
                    .attr("id", function (d) { return d.id; })
                    .attr("d", path)
                    .style("fill", "lightyellow")
                    .style("stroke", "gray")
                    .style("stroke-width", 1)
                    .style("stroke-opacity", 1)
                    .on("click", function (d) {
                        var regionName = d.target.__data__.properties.NAME_1;
                        
                    });
    
                var interval;
    
                function updateData(month, day) {
                    selectedMonth = month;
                    selectedDay = day;
                    var csvFile;
                    if (day === "-") {
                        csvFile = "FIRMS grupirano/" + month + ".csv";
                    } else {
                        var dayStr = day < 10 ? "0" + day : day;
                        var monthStr = month < 10 ? "0" + month : month;
                        csvFile = "FIRMS/2022-" + monthStr + "-" + dayStr + "_.csv";
                    }
                    d3.csv(csvFile)
                        .then(function (data) {
                            if(!isRegionSet)
                            {
                                svg.selectAll(".point").remove();
                                const colorScale = d3.scaleLinear()
                                    .domain([0, d3.max(data, function(d) { return d.frp; })])
                                    .range(["#FF3333", "#8B0000"]);
                                svg.selectAll(".point")
                                    .data(data)
                                    .enter().append("circle")
                                    .attr("class", "point")
                                    .attr("r", function (d) { return Math.sqrt(d.frp) * FireScaling / 4; })
                                    .attr("cx", function (d) { return projection([d.longitude, d.latitude])[0]; })
                                    .attr("cy", function (d) { return projection([d.longitude, d.latitude])[1]; })
                                    .style("fill", function (d) { return colorScale(d.frp);})
                                    .append("title")
                                    .text(function (d) { return "Coordinates: " + d.longitude + ", " + d.latitude  + "\nDate: " + d.acq_date + "\nFire radiative power: " + d.frp + "MW"});
                            }
                            else {
                                    var pointCounts = d3.rollups(data, v => v.length, d => {
                                        var regionName;
                                        ukrFeatures.features.forEach(feature => {
                                            var geometry = feature.geometry;
                                            var point = [d.longitude, d.latitude];
                                            if (d3.geoContains(geometry, point)) {
                                                regionName = feature.properties.NAME_1;
                                            }
                                        });
                                        return regionName;
                                    });

                                    svg.selectAll(".county")
                                        .style("fill", function (d) {
                                            var regionName = d.properties.NAME_1;
                                            var regionCount = pointCounts.find(function (pointCount) { return pointCount[0] === regionName; });
                                            var count = regionCount ? regionCount[1] : 0;
                                            d3.select(this)
                                                .select("title")
                                                .remove();

                                            d3.select(this)
                                                .append("title")
                                                .text( "Number of Fires detected\n" +regionName + ": " + count)
                                            return regionCount ? regionColorScale(regionCount[1]) : "lightyellow";
                                        });
                                }

                        });
                }
    
                function playAnimation() {
                var nextDay, nextMonth;

                if (selectedDay === "-") {
                    nextDay = "-";
                    nextMonth = (parseInt(selectedMonth)) + 1;
                    if(nextMonth > 12)
                        nextMonth = 2;
                    document.getElementById("month-select").value = nextMonth;
                    updateDayOptions(nextMonth);
                } else {
                    var daysInMonth = new Date(2022, parseInt(selectedMonth), 0).getDate();
                    nextDay = (parseInt(selectedDay) % daysInMonth) + 1;
                    daySelect.value = nextDay;
                    nextMonth = selectedMonth;
                    if (nextDay === 1) {
                        nextMonth = (parseInt(selectedMonth)) + 1;
                        if(nextMonth > 12)
                            nextMonth = 2;
                        document.getElementById("month-select").value = nextMonth;
                        updateDayOptions(nextMonth);
                    }
                }

                updateData(nextMonth, nextDay);
                }
    
                function updateDayOptions(month) {
                    daySelect.innerHTML = "";
                    var nullOption = document.createElement("option");
                        nullOption.value = "-";
                        nullOption.textContent = "-";
                        daySelect.appendChild(nullOption);
                    var daysInMonth = new Date(2022, month, 0).getDate();
                    if(month == "2")
                        for (var i = 24; i <= daysInMonth; i++) {
                            var dayOption = document.createElement("option");
                            dayOption.value = i;
                            dayOption.textContent = i;
                            daySelect.appendChild(dayOption);
                        }
                    else
                        for (var i = 1; i <= daysInMonth; i++) {
                            var dayOption = document.createElement("option");
                            dayOption.value = i;
                            dayOption.textContent = i;
                            daySelect.appendChild(dayOption);
                        }
                        daySelect.value = selectedDay;
                }
    
                d3.select("#month-select")
                    .on("change", function () {
                        selectedMonth = this.value;
                        if(selectedMonth === "2" && selectedDay < 24)
                            {
                                 selectedDay = "24";
                            }
                        updateData(selectedMonth, selectedDay);
                        updateDayOptions(selectedMonth);
                    });
    
                d3.select("#day-select")
                    .on("change", function () {
                        selectedDay = this.value;
                        updateData(selectedMonth, selectedDay);
                    });
    
                d3.select("#play-button")
                    .on("click", function () {
                        if (interval) {
                            clearInterval(interval);
                            interval = null;
                            d3.select(this).text("Play");
                        } else {
                            interval = setInterval(playAnimation, animInterval);
                            d3.select(this).text("Stop");
                        }
                    });
    
                const defaultMonth = "2";
                const defaultDay = "-";
                regionsButton.disabled = false;
                pointsButton.disabled = true;
                updateDayOptions(defaultMonth);
                updateData(defaultMonth, defaultDay);

                fireScaleInput.addEventListener("input", function() {
                FireScaling = parseInt(fireScaleInput.value);
                fireScaleValue.textContent = FireScaling;
                updateData(selectedMonth, selectedDay);
                });


                regionsButton.addEventListener("click", function () {
                    isRegionSet = true;
                    regionsButton.disabled = true;
                    pointsButton.disabled = false;
                    scalingInput.classList.add("disabled");
                    svg.selectAll(".point").remove();
                    updateData(selectedMonth, selectedDay);
                });

                pointsButton.addEventListener("click", function () {
                    isRegionSet = false;
                    regionsButton.disabled = false;
                    pointsButton.disabled = true;
                    scalingInput.classList.remove("disabled");
                    svg.selectAll(".county")
                        .style("fill", "lightyellow");
                    updateData(selectedMonth, selectedDay);
                });

                animIntervalInput.addEventListener("input", function() {
                animInterval = parseInt(animIntervalInput.value) * 1000;
                });


            });

     
    </script>
</body>
