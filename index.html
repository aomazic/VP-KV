<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
</head>
<body>
    <select id="month-select">
        <option value="2">February</option>
        <option value="3">March</option>
        <option value="4">April</option>
        <option value="5">May</option>
        <option value="6">June</option>
        <option value="7">July</option>
        <option value="8">August</option>
        <option value="9">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
    </select>
    <select id="day-select">
        <option value="-">-</option>
    </select>
    <button id="play-button">Play</button>
    <script>
        var width = 1000;
        var height = 1000;
        var selectedMonth;
        var selectedDay;
        var projection = d3.geoMercator()
        var colorScale = d3.scaleLinear()
        var path = d3.geoPath()
            .projection(projection);

        var colorScale = d3.scaleLinear()
             .range(['lightred', 'darkred'])
    
        d3.csv("all.csv")
            .then(function (data) {
                colorScale.domain([0, d3.max(data, function(d) { return d.frp; })]);
            });
         
    
        var svg = d3.select("body").append("svg")
            .attr("id", "map-svg")
            .attr("width", width)
            .attr("height", height)
            .append("g");
    
        d3.select("body")
            .append("div")
            .attr("id", "name");
    
        d3.json("ukr.json")
            .then(function (ukr) {
                var ukrFeatures = topojson.feature(ukr, ukr.objects.UKR_adm1);
                projection.fitSize([width, height], ukrFeatures);
                var states = svg.selectAll("path.county")
                    .data(ukrFeatures.features)
                    .enter()
                    .append("path")
                    .attr("class", "county")
                    .attr("id", function (d) { return d.id; })
                    .attr("d", path)
                    .style("fill", "lightyellow")
                    .style("stroke", "gray")
                    .style("stroke-width", 1)
                    .style("stroke-opacity", 1);
    
                var interval;
    
                function updateData(month, day) {
                    selectedMonth = month;
                    selectedDay = day;
                    var csvFile;
                    if (day === "-") {
                        csvFile = "FIRMS grupirano/" + month + ".csv";
                    } else {
                        var dayStr = day < 10 ? "0" + day : day;
                        var monthStr = month < 10 ? "0" + month : month;
                        csvFile = "FIRMS/2022-" + monthStr + "-" + dayStr + "_.csv";
                    }
                    d3.csv(csvFile)
                        .then(function (data) {
                            svg.selectAll(".point").remove();
    
                            svg.selectAll(".point")
                                .data(data)
                                .enter().append("circle")
                                .attr("class", "point")
                                .attr("r", 2)
                                .attr("cx", function (d) { return projection([d.longitude, d.latitude])[0]; })
                                .attr("cy", function (d) { return projection([d.longitude, d.latitude])[1]; })
                                .style("fill", function (d) { return colorScale(d.frp);})
                                .append("title")
                                .text(function (d) { return "Brightness: " + d.brightness + "\nConfidence: " + d.confidence + "\nDay/Night: " + d.daynight; });
                        });
                }
    
                function playAnimation() {
                var nextDay, nextMonth;

                if (selectedDay === "-") {
                    nextDay = "-";
                    nextMonth = (parseInt(selectedMonth)) + 1;
                    if(nextMonth > 12)
                        nextMonth = 2;
                    document.getElementById("month-select").value = nextMonth;
                    updateDayOptions(nextMonth);
                } else {
                    var daysInMonth = new Date(2022, parseInt(selectedMonth), 0).getDate();
                    nextDay = (parseInt(selectedDay) % daysInMonth) + 1;
                    document.getElementById("day-select").value = nextDay;
                    nextMonth = selectedMonth;
                    if (nextDay === 1) {
                        nextMonth = (parseInt(selectedMonth)) + 1;
                        if(nextMonth > 12)
                            nextMonth = 2;
                        document.getElementById("month-select").value = nextMonth;
                        updateDayOptions(nextMonth);
                    }
                }

                updateData(nextMonth, nextDay);
            }
    
                function updateDayOptions(month) {
                    var daySelect = document.getElementById("day-select");
                    daySelect.innerHTML = "";
                    var nullOption = document.createElement("option");
                        nullOption.value = "-";
                        nullOption.textContent = "-";
                        daySelect.appendChild(nullOption);
                    var daysInMonth = new Date(2022, month, 0).getDate();
                    if(month == "2")
                        for (var i = 24; i <= daysInMonth; i++) {
                            var dayOption = document.createElement("option");
                            dayOption.value = i;
                            dayOption.textContent = i;
                            daySelect.appendChild(dayOption);
                        }
                    else
                        for (var i = 1; i <= daysInMonth; i++) {
                            var dayOption = document.createElement("option");
                            dayOption.value = i;
                            dayOption.textContent = i;
                            daySelect.appendChild(dayOption);
                        }
                }
    
                d3.select("#month-select")
                    .on("change", function () {
                        selectedMonth = this.value;
                        updateData(selectedMonth, selectedDay);
                        updateDayOptions(selectedMonth);
                    });
    
                d3.select("#day-select")
                    .on("change", function () {
                        selectedDay = this.value;
                        updateData(selectedMonth, selectedDay);
                    });
    
                d3.select("#play-button")
                    .on("click", function () {
                        if (interval) {
                            clearInterval(interval);
                            interval = null;
                            d3.select(this).text("Play");
                        } else {
                            interval = setInterval(playAnimation, 2500);
                            d3.select(this).text("Stop");
                        }
                    });
    
                var defaultMonth = "2";
                var defaultDay = "-";
                updateDayOptions(defaultMonth);
                updateData(defaultMonth, defaultDay);
            });
    </script>
</body>
